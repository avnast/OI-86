{"AWSTemplateFormatVersion":"2010-09-09","Description":"kube-aws Kubernetes node pool avnast-k8s-cluster nodepool1","Parameters":{"ControlPlaneStackName":{"Type":"String","Description":"The name of a control-plane stack used to import values into this stack"}},"Resources":{"Workers":{"Properties":{"HealthCheckGracePeriod":600,"HealthCheckType":"EC2","LaunchConfigurationName":{"Ref":"WorkersLC"},"MaxSize":"1","MetricsCollection":[{"Granularity":"1Minute"}],"MinSize":"1","Tags":[{"Key":"creator","PropagateAtLaunch":"true","Value":"aleksei_n"},{"Key":"instanceRole","PropagateAtLaunch":"true","Value":"worker"},{"Key":"task_id","PropagateAtLaunch":"true","Value":"OI-86"},{"Key":"kubernetes.io/cluster/avnast-k8s-cluster","PropagateAtLaunch":"true","Value":"owned"},{"Key":"kube-aws:node-pool:name","PropagateAtLaunch":"true","Value":"nodepool1"},{"Key":"Name","PropagateAtLaunch":"true","Value":"avnast-k8s-cluster-nodepool1-kube-aws-worker"}],"VPCZoneIdentifier":[{"Fn::ImportValue":{"Fn::Sub":"${ControlPlaneStackName}-Subnet0"}}]},"Type":"AWS::AutoScaling::AutoScalingGroup","CreationPolicy":{"ResourceSignal":{"Count":"1","Timeout":"PT15M"}},"UpdatePolicy":{"AutoScalingRollingUpdate":{"MinInstancesInService":"0","WaitOnResourceSignals":"true","MaxBatchSize":"1","PauseTime":"PT15M"}},"Metadata":{"AWS::CloudFormation::Init":{"configSets":{"etcd-client":["etcd-client-env"]},"etcd-client-env":{"files":{"/var/run/coreos/etcd-environment":{"content":{"Fn::Join":["",["ETCD_ENDPOINTS='","https://",{"Fn::Join":[".",[{"Fn::Join":["-",["ec2",{"Fn::Join":["-",{"Fn::Split":[".",{"Fn::ImportValue":{"Fn::Sub":"${ControlPlaneStackName}-Etcd0EIP"}}]}]}]]},"us-west-2.compute.amazonaws.com"]]},":2379","'\n"]]}}}}}}},"WorkersLC":{"Properties":{"BlockDeviceMappings":[{"DeviceName":"/dev/xvda","Ebs":{"VolumeSize":"30","VolumeType":"gp2"}}],"IamInstanceProfile":{"Ref":"IAMInstanceProfileWorker"},"ImageId":"ami-692faf11","InstanceType":"t2.medium","KeyName":"av.nast","SecurityGroups":[{"Fn::ImportValue":{"Fn::Sub":"${ControlPlaneStackName}-WorkerSecurityGroup"}}],"PlacementTenancy":"default","UserData":{"Fn::Base64":{"Fn::Join":["",["#!/bin/bash -xe\n",{"Fn::Join":["",["echo 'KUBE_AWS_STACK_NAME=",{"Ref":"AWS::StackName"},"' >> /etc/environment\n"]]},". /etc/environment\nexport COREOS_PRIVATE_IPV4 COREOS_PRIVATE_IPV6 COREOS_PUBLIC_IPV4 COREOS_PUBLIC_IPV6\nREGION=$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | jq -r '.region')\nUSERDATA_FILE=userdata-worker\n\nrun() {\n  bin=\"$1\"; shift\n  while ! /usr/bin/rkt run \\\n    --net=host \\\n    --volume=dns,kind=host,source=/etc/resolv.conf,readOnly=true --mount volume=dns,target=/etc/resolv.conf \\\n    --volume=awsenv,kind=host,source=/var/run/coreos,readOnly=false --mount volume=awsenv,target=/var/run/coreos \\\n    --volume=envfile,kind=host,source=/etc/environment,readOnly=false --mount volume=envfile,target=/etc/environment  \\\n    --trust-keys-from-https \\\n    quay.io/coreos/awscli:master --exec=$bin -- \"$@\"; do\n      sleep 1\n  done\n}\nrun bash -c \"aws configure set s3.signature_version s3v4; aws s3 --region $REGION cp s3://oi-86/k8s/kube-aws/clusters/avnast-k8s-cluster/exported/stacks/nodepool1/userdata-worker-7334e15f12998894d7c9a17d724459e4ba38a992638e791d072c57bb42a09f8f /var/run/coreos/$USERDATA_FILE\"\n\nINSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n\nexec /usr/bin/coreos-cloudinit --from-file /var/run/coreos/$USERDATA_FILE\n"]]}}},"Type":"AWS::AutoScaling::LaunchConfiguration"},"IAMInstanceProfileWorker":{"Properties":{"Path":"/","Roles":[{"Ref":"IAMRoleWorker"}]},"Type":"AWS::IAM::InstanceProfile"},"IAMManagedPolicyWorker":{"Type":"AWS::IAM::ManagedPolicy","Properties":{"Description":"Policy for managing kube-aws k8s Node Pool nodepool1 ","Path":"/","PolicyDocument":{"Version":"2012-10-17","Statement":[{"Action":"ec2:Describe*","Effect":"Allow","Resource":"*"},{"Action":"ec2:AttachVolume","Effect":"Allow","Resource":"*"},{"Action":"ec2:DetachVolume","Effect":"Allow","Resource":"*"},{"Effect":"Allow","Action":["s3:GetObject"],"Resource":"arn:aws:s3:::oi-86/k8s/kube-aws/clusters/avnast-k8s-cluster/exported/stacks/nodepool1/userdata-worker*"},{"Action":"kms:Decrypt","Effect":"Allow","Resource":"arn:aws:kms:us-west-2:762510625864:key/3ad2bd66-9fbc-4e6d-9ea8-c6b4c1cc6617"},{"Action":"cloudformation:SignalResource","Effect":"Allow","Resource":{"Fn::Join":["",["arn:aws:cloudformation:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":stack/",{"Ref":"AWS::StackName"},"/*"]]}},{"Action":["ecr:GetAuthorizationToken","ecr:BatchCheckLayerAvailability","ecr:GetDownloadUrlForLayer","ecr:GetRepositoryPolicy","ecr:DescribeRepositories","ecr:ListImages","ecr:BatchGetImage"],"Resource":"*","Effect":"Allow"}]}}},"IAMRoleWorker":{"Properties":{"AssumeRolePolicyDocument":{"Statement":[{"Action":["sts:AssumeRole"],"Effect":"Allow","Principal":{"Service":["ec2.amazonaws.com"]}}],"Version":"2012-10-17"},"Path":"/","ManagedPolicyArns":[{"Ref":"IAMManagedPolicyWorker"}]},"Type":"AWS::IAM::Role"}},"Outputs":{"WorkerIAMRoleArn":{"Description":"The ARN of the IAM role for this Node Pool","Value":{"Fn::GetAtt":["IAMRoleWorker","Arn"]},"Export":{"Name":{"Fn::Sub":"${AWS::StackName}-WorkerIAMRoleArn"}}},"StackName":{"Description":"The name of this stack","Value":{"Ref":"AWS::StackName"}}}}